<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ›¸é¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</title>

<link rel="manifest" href="./manifest.json">

<style>
  *,*::before,*::after{box-sizing:border-box}
  :root{--primary:#1556d1;--danger:#ef5753;--ok:#137333;--fg:#111;--muted:#666;--bg:#f6f7fb;--card:#fff}
  html,body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans JP',sans-serif;line-height:1.6;margin:0}
  .wrap{max-width:880px;margin:0 auto;padding:20px}
  .card{background:var(--card);border-radius:18px;box-shadow:0 2px 14px rgba(0,0,0,.06);padding:20px}
  h1{font-size:22px;margin:0 0 8px}
  label{display:block;font-weight:800;margin:14px 0 6px}
  input[type="text"]{width:100%;padding:14px 16px;border:1px solid #ddd;border-radius:14px;font-size:16px}

  .btn{appearance:none;border:0;border-radius:14px;padding:14px 16px;font-weight:900;font-size:16px;cursor:pointer;transition:transform .02s ease}
  .btn:active{transform:translateY(1px)}
  .btn-primary{background:var(--primary);color:#fff}
  .btn-danger{background:var(--danger);color:#fff}
  .btn[disabled]{opacity:.6;cursor:not-allowed}

  .btn-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0}
  .btn-bar{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0}

  .hint{font-size:14px;color:var(--muted);margin:6px 0}
  .mini{font-size:12px;color:var(--muted);margin-top:4px}

  .msg{padding:12px 14px;border-radius:12px;margin:10px 0;font-size:16px}
  .msg-ok{background:#e9f5ee;color:var(--ok);border:1px solid #bfe5cd}
  .msg-bad{background:#fdecec;color:#a12121;border:1px solid #f3c3c0}
  .msg-info{background:#eef3ff;color:#274291;border:1px solid #cfdcff}

  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-top:10px}
  .thumb{background:#fafafa;border:1px solid #eee;border-radius:14px;overflow:hidden}
  .thumb img{width:100%;height:120px;object-fit:cover;display:block;background:#fff}
  .thumb .meta{padding:8px 10px;font-size:14px}
  .thumb .row{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .remove{background:#ffe7e7;color:#a12121;border:0;border-radius:10px;padding:6px 8px;font-weight:900;cursor:pointer}

  .progress{height:10px;background:#e8eefc;border-radius:999px;overflow:hidden;margin:10px 0 0}
  .bar{width:40%;height:100%;background:var(--primary);animation:indef 1.2s infinite}
  @keyframes indef{0%{transform:translateX(-60%)}100%{transform:translateX(160%)}}

  .done{display:none;margin-top:14px}.done.show{display:block}
  .done h2{margin:0 0 6px;font-size:22px}

  /* é€ä¿¡å…ˆ */
  .dest-box{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin:8px 0 6px}
  .dest-item{background:#f2f6ff;border:2px solid #d9e4ff;border-radius:16px;padding:14px 14px;display:flex;gap:10px;align-items:center;cursor:pointer;user-select:none}
  .dest-item input{width:22px;height:22px}
  .dest-item.active{border-color:#1556d1;background:#eaf0ff}
  .dest-title{font-weight:900;font-size:18px}

  /* ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:9999}
  .modal.show{display:flex}
  .cam{background:#000;width:100%;max-width:1000px;color:#fff;display:flex;flex-direction:column;height:100svh}
  .cam video{flex:1 1 auto;width:100%;object-fit:cover}
  .cam .controls{display:flex;gap:10px;justify-content:space-between;padding:12px;background:rgba(0,0,0,.6)}
  .cam .btn{flex:1;padding:14px;border-radius:12px}

  /* ãƒˆãƒ¼ã‚¹ãƒˆ */
  .toast{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#e9f5ee;color:#0b6e3f;border:1px solid #bfe5cd;
         padding:10px 14px;border-radius:999px;box-shadow:0 4px 16px rgba(0,0,0,.15);z-index:10000;display:none}
  .toast.show{display:block;animation:fade 2.4s ease forwards}
  @keyframes fade{0%{opacity:0;transform:translate(-50%,-6px)}10%{opacity:1;transform:translate(-50%,0)}90%{opacity:1}100%{opacity:0}}
</style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>æ›¸é¡ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h1>

      <form id="f" autocomplete="off" novalidate>
        <label>é€ä¿¡å…ˆï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
        <div id="destBox" class="dest-box"></div>
        <div class="mini">â€» é¸ã‚“ã éƒ¨ç½²ã™ã¹ã¦ã«åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>

        <label>åˆ©ç”¨è€…åãƒ»CMå ç­‰ï¼ˆä»»æ„ï¼‰</label>
        <input type="text" id="note" placeholder="ä¾‹ï¼‰å±±ç”° å¤ªéƒï¼CMåï¼äº‹æ¥­æ‰€å ãªã©" />

        <label>å†™çœŸãƒ»PDFï¼ˆæœ€å¤§ 8 æšï¼‰</label>

        <div class="btn-row">
          <button type="button" class="btn btn-primary" id="pickBtn">ğŸ“ ã‚¢ãƒ«ãƒãƒ ã‹ã‚‰é¸ã¶</button>
          <button type="button" class="btn btn-primary" id="camBtn">ğŸ“¸ å†™çœŸã‚’æ’®ã‚‹</button>
        </div>

        <div class="mini">â€» 1ãƒ•ã‚¡ã‚¤ãƒ«ä¸Šé™ï¼š<strong>20MB</strong>ï¼ˆjpeg / png / pdfï¼‰</div>

        <input id="pick" type="file" accept="image/jpeg,image/png,application/pdf" multiple style="display:none">
        <input id="cameraFile" type="file" accept="image/*" capture="environment"
               style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0">

        <div class="btn-bar">
          <button type="button" class="btn btn-danger" id="clearBtn">âœ– ã™ã¹ã¦å‰Šé™¤</button>
        </div>

        <div id="precheck" class="msg msg-info" role="status" aria-live="polite">æº–å‚™ä¸­â€¦</div>
        <div class="thumbs" id="thumbs" aria-live="polite"></div>

        <div class="btn-bar" style="margin-top:14px">
          <button class="btn btn-primary" id="sendBtn" type="submit" disabled>â¬† é€ä¿¡ã™ã‚‹</button>
        </div>

        <div id="sending" class="msg msg-info" style="display:none" role="status" aria-live="assertive">
          â³ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã§ã™ã€‚ç”»é¢ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„ã€‚
          <div id="progText" class="mini" style="margin-top:6px"></div>
          <div class="progress"><div class="bar"></div></div>
        </div>

        <div id="done" class="msg msg-ok done" role="status" aria-live="assertive">
          <h2>âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ</h2>
          <div class="mini">å¿…è¦ãªã‚‰åˆ¥ã®é€ä¿¡å…ˆã‚‚ãƒã‚§ãƒƒã‚¯ã—ã¦ã€è¿½åŠ ã§é€ã£ã¦ãã ã•ã„ã€‚</div>
        </div>
      </form>
    </div>
  </div>

  <!-- ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="camModal" class="modal" aria-hidden="true">
    <div class="cam" role="dialog" aria-label="ã‚«ãƒ¡ãƒ©ã§æ’®å½±">
      <video id="camVideo" autoplay playsinline></video>
      <div class="controls">
        <button type="button" class="btn" id="camClose">å®Œäº†ã—ã¦é–‰ã˜ã‚‹</button>
        <button type="button" class="btn btn-primary" id="camShot">æ’®å½±ã—ã¦è¿½åŠ </button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">âœ… è¿½åŠ ã—ã¾ã—ãŸ</div>

<script>
  /* ========= ã“ã“ã ã‘ã‚ãªãŸã® /exec ã«å¤‰æ›´ ========= */
  const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbxeoxE-aJp0H5GCtxWAotUa-nbKo7LiMwSHrlcLBTrCkGkvV98iVn2uTeoQwx7OfH5B/exec';
  /* ============================================== */

  const ALLOW_MIME = ['image/jpeg','image/png','application/pdf'];
  const MAX_BYTES  = 20*1024*1024;
  const MAX_FILES  = 8;

  const KEY_STORAGE = 'upload_key_v1';

  const queue = [];
  const $ = s => document.querySelector(s);

  const pickInput = $('#pick');
  const cameraFile = $('#cameraFile');
  const thumbs = $('#thumbs');
  const precheck = $('#precheck');
  const sendBtn = $('#sendBtn');
  const sending = $('#sending');
  const doneBox = $('#done');
  const toast = $('#toast');
  const progText = $('#progText');

  // é€ä¿¡å…ˆ
  const destBox = document.getElementById('destBox');

  // ã‚«ãƒ¡ãƒ©
  const camModal = $('#camModal');
  const camVideo = $('#camVideo');
  const camClose = $('#camClose');
  const camShot  = $('#camShot');
  let camStream = null;

  // ===== éµï¼šQRã«åŸ‹ã‚è¾¼ã‚€ â†’ ç«¯æœ«ä¿å­˜ â†’ URLã‹ã‚‰æ¶ˆã™ï¼ˆå…¥åŠ›ã‚¼ãƒ­ï¼‰ =====
  const qs = new URLSearchParams(location.search);
  let AUTH_KEY = (qs.get('k') || '').trim();

  if (AUTH_KEY) {
    try { localStorage.setItem(KEY_STORAGE, AUTH_KEY); } catch(_) {}
    try {
      qs.delete('k');
      const q = qs.toString();
      history.replaceState(null, '', location.pathname + (q ? ('?' + q) : ''));
    } catch(_) {}
  } else {
    try { AUTH_KEY = (localStorage.getItem(KEY_STORAGE) || '').trim(); } catch(_) {}
  }

  function requireAuthKey(){
    if(!AUTH_KEY){
      precheck.className='msg msg-bad';
      precheck.innerHTML='âš  ã“ã®ç«¯æœ«ã«ã¯é€ä¿¡æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚é…å¸ƒã•ã‚ŒãŸQRã‚³ãƒ¼ãƒ‰ã‹ã‚‰é–‹ã„ã¦ãã ã•ã„ã€‚';
      setUIEnabled(false);
      return false;
    }
    return true;
  }

  function setUIEnabled(enabled){
    $('#pickBtn').disabled = !enabled;
    $('#camBtn').disabled  = !enabled;
    sendBtn.disabled       = !enabled;
  }

  function getSelectedDestIds(){
    return Array.from(destBox.querySelectorAll('input[type=checkbox]:checked')).map(x=>x.value);
  }

  // ===== é€ä¿¡å…ˆã‚’APIã‹ã‚‰å–å¾—ï¼ˆå¢—ãˆã¦ã‚‚GitHubå´ã‚’ç›´ã•ãªã„ï¼‰ =====
  async function loadDestinations(){
    try{
      const url = API_ENDPOINT + '?action=listDest';
      const res = await fetch(url, { method:'GET' });
      const js = await res.json();
      if(!js.ok || !Array.isArray(js.dests)) throw new Error('listDest failed');

      destBox.innerHTML='';
      for(const d of js.dests){
        const wrap = document.createElement('label');
        wrap.className = 'dest-item';
        wrap.innerHTML = `<input type="checkbox" value="${escapeHtml(d.id)}">
                          <div class="dest-title">${escapeHtml(d.label)}</div>`;
        const cb = wrap.querySelector('input');
        cb.addEventListener('change', ()=> wrap.classList.toggle('active', cb.checked));
        wrap.classList.toggle('active', cb.checked);
        destBox.appendChild(wrap);
      }
    }catch(e){
      // æœ€ä½é™ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆAPIä¸èª¿ã§ã‚‚å£Šã‚Œãªã„ï¼‰
      destBox.innerHTML = `
        <label class="dest-item"><input type="checkbox" value="tokuyo"><div class="dest-title">ç‰¹é¤Š</div></label>
        <label class="dest-item"><input type="checkbox" value="ss"><div class="dest-title">SS</div></label>
        <label class="dest-item"><input type="checkbox" value="tsusho"><div class="dest-title">é€šæ‰€</div></label>
      `;
      destBox.querySelectorAll('.dest-item').forEach(w=>{
        const cb=w.querySelector('input');
        cb.addEventListener('change', ()=> w.classList.toggle('active', cb.checked));
      });
    }
  }

  // ===== UIæ“ä½œ =====
  $('#pickBtn').onclick = ()=>{
    if(!requireAuthKey()) return;
    if(getSelectedDestIds().length===0){ showToast('âš  é€ä¿¡å…ˆã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
    pickInput.click();
  };
  $('#camBtn').onclick = ()=>{
    if(!requireAuthKey()) return;
    if(getSelectedDestIds().length===0){ showToast('âš  é€ä¿¡å…ˆã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
    openCameraOrFallback();
  };
  $('#clearBtn').onclick = ()=>{ queue.length=0; render(); };

  pickInput.addEventListener('change', e=>{
    for(const f of e.target.files) queue.push(f);
    e.target.value='';
    render();
  });
  cameraFile.addEventListener('change', e=>{
    if(e.target.files[0]) queue.push(e.target.files[0]);
    e.target.value='';
    render();
  });

  // ===== ã‚«ãƒ¡ãƒ©èµ·å‹• =====
  async function openCameraOrFallback(){
    if(!navigator.mediaDevices?.getUserMedia){ cameraFile.click(); return; }
    try{
      camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal:'environment' } }, audio:false });
      camVideo.srcObject = camStream;
      if (camVideo.readyState < 2) await new Promise(ok => camVideo.addEventListener('loadeddata', ok, {once:true}));
      camModal.classList.add('show');
      camModal.setAttribute('aria-hidden','false');
      document.body.style.overflow='hidden';
    }catch(_){
      cameraFile.click();
    }
  }
  function stopCamera(){
    if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; }
    camVideo.srcObject = null;
    camModal.classList.remove('show');
    camModal.setAttribute('aria-hidden','true');
    document.body.style.overflow='';
  }
  camClose.onclick = ()=>{ stopCamera(); render(); };

  camShot.onclick = async ()=>{
    if(!camStream) return;
    try{
      const blob = await snapFromVideo();
      const d=new Date(), z=n=>String(n).padStart(2,'0');
      const name=`${d.getFullYear()}${z(d.getMonth()+1)}${z(d.getDate())}_${z(d.getHours())}${z(d.getMinutes())}${z(d.getSeconds())}.jpg`;
      const fileLike = toFileLike(blob, name);
      queue.push(fileLike);
      showToast('âœ… è¿½åŠ ã—ã¾ã—ãŸ');
      render();
    }catch(_){
      showToast('âš  æ’®å½±ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ¨©é™/ãƒ–ãƒ©ã‚¦ã‚¶ç¢ºèªï¼‰');
    }
  };

  async function snapFromVideo(){
    const w = camVideo.videoWidth || 1280;
    const h = camVideo.videoHeight || 720;
    const c = document.createElement('canvas'); c.width = w; c.height = h;
    const ctx = c.getContext('2d'); ctx.drawImage(camVideo, 0, 0, w, h);
    return await blobFromCanvas(c, 'image/jpeg', 0.95);
  }
  async function blobFromCanvas(canvas, mime='image/jpeg', quality=0.95){
    if (canvas.toBlob){
      const b = await new Promise(res=>canvas.toBlob(res, mime, quality));
      if (b) return b;
    }
    const dataUrl = canvas.toDataURL(mime, quality);
    return await (await fetch(dataUrl)).blob();
  }
  function toFileLike(blob, name){
    try{ return new File([blob], name, { type: blob.type||'image/jpeg' }); }
    catch(_){ Object.defineProperty(blob,'name',{value:name}); return blob; }
  }

  // ===== é€ä¿¡ =====
  document.getElementById('f').addEventListener('submit', (e)=>{
    e.preventDefault();
    if(!requireAuthKey()) return;

    const destIds = getSelectedDestIds();
    if(destIds.length===0){ showToast('âš  é€ä¿¡å…ˆã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
    if(queue.length===0) return;

    (async ()=>{
      setUIEnabled(false);
      sending.style.display='block';
      doneBox.classList.remove('show');
      progText.textContent='';

      const note = document.getElementById('note').value || '';
      const total = queue.length;

      for(let idx=0; idx<queue.length; idx++){
        const f = queue[idx];
        progText.textContent = `é€ä¿¡ä¸­ï¼š${idx+1}/${total}`;

        const packed = await packToLimit(f, MAX_BYTES);
        const payload = {
          key: AUTH_KEY,
          note,
          destIds,
          items: [{
            name: (f.name || 'upload.bin'),
            mime: packed.mime,
            base64: packed.base64
          }]
        };

        const res = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });

        const txt = await res.text();
        let js=null; try{ js=JSON.parse(txt); }catch(_){}
        if(!js || !js.ok){
          precheck.className='msg msg-bad';
          precheck.innerHTML = `âš  é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ${escapeHtml((js && js.error) ? js.error : 'unknown')}ï¼‰<br>é€šä¿¡çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`;
          sending.style.display='none';
          setUIEnabled(true);
          return;
        }
      }

      sending.style.display='none';
      doneBox.classList.add('show');
      queue.length = 0;
      render();
      setUIEnabled(true);
    })();
  });

  // ===== è¡¨ç¤º =====
  function render(){
    thumbs.innerHTML='';
    if(queue.length>0) doneBox.classList.remove('show');

    if(!requireAuthKey()){ return; }

    // 8æšåˆ¶é™ï¼ˆå¤–éƒ¨å‘ã‘ã«äº‹æ•…ã‚’æ¸›ã‚‰ã™ï¼‰
    if(queue.length > MAX_FILES){
      precheck.className='msg msg-bad';
      precheck.innerHTML = `âš  æœ€å¤§ ${MAX_FILES} æšã¾ã§ã§ã™ã€‚<br>ã„ã¾ ${queue.length} æšã‚ã‚Šã¾ã™ã€‚æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚`;
      sendBtn.disabled = true;
      return;
    }

    // é€ä¿¡å…ˆãŒæœªé¸æŠãªã‚‰æ­¢ã‚ã‚‹
    if(getSelectedDestIds().length===0){
      precheck.className='msg msg-info';
      precheck.textContent='é€ä¿¡å…ˆã‚’é¸ã‚“ã§ãã ã•ã„ã€‚';
      sendBtn.disabled = true;
    }

    if(queue.length===0){
      precheck.className='msg msg-info';
      precheck.textContent='ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã¶ã‹ã€å†™çœŸã‚’æ’®ã£ã¦ãã ã•ã„ã€‚';
      sendBtn.disabled = true;
      return;
    }

    queue.forEach((f,i)=>{
      const card=document.createElement('div'); card.className='thumb';
      const img=document.createElement('img');
      if((f.type||'').startsWith('image/')){ img.src=URL.createObjectURL(f); img.onload=()=>URL.revokeObjectURL(img.src); }
      else { img.alt='PDF'; img.style.background='#eef3ff'; }
      const meta=document.createElement('div'); meta.className='meta';
      meta.innerHTML=`<div class="row"><strong>${escapeHtml(f.name || 'file')}</strong></div>
                      <div class="row"><span>${(f.size/1024/1024).toFixed(1)} MB</span>
                      <button type="button" class="remove" data-i="${i}">å‰Šé™¤</button></div>`;
      card.appendChild(img); card.appendChild(meta); thumbs.appendChild(card);
    });
    document.querySelectorAll('.remove').forEach(b=>b.onclick=e=>{ queue.splice(Number(e.currentTarget.dataset.i),1); render(); });

    // MIMEãƒã‚§ãƒƒã‚¯
    if(queue.some(f=>!ALLOW_MIME.includes((f.type||'').toLowerCase()))){
      precheck.className='msg msg-bad';
      precheck.innerHTML='âš  é€ä¿¡ã§ããªã„å½¢å¼ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼ˆjpeg / png / pdfã®ã¿ï¼‰ã€‚';
      sendBtn.disabled=true; return;
    }

    // éç”»åƒã¯20MBè¶…ãªã‚‰å³NGï¼ˆç”»åƒã¯é€ä¿¡æ™‚ã«æœ€é©åŒ–ï¼‰
    const overs = queue.filter(f=>!(f.type||'').startsWith('image/') && f.size>MAX_BYTES);
    if(overs.length){
      precheck.className='msg msg-bad';
      precheck.innerHTML=`âš  PDFãŒä¸Šé™ï¼ˆ20MBï¼‰ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`;
      sendBtn.disabled=true; return;
    }

    const sum=queue.reduce((s,f)=>s+f.size,0);
    precheck.className='msg msg-ok';
    precheck.innerHTML=`ğŸ‘ é€ä¿¡ã§ãã¾ã™ã€‚æšæ•°ï¼š<strong>${queue.length}</strong>ã€åˆè¨ˆï¼šç´„<strong>${(sum/1024/1024).toFixed(1)}MB</strong>`;
    sendBtn.disabled = (getSelectedDestIds().length===0);
  }

  // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  function showToast(msg){
    toast.textContent=msg;
    toast.classList.remove('show');
    requestAnimationFrame(()=>{ toast.classList.add('show'); });
  }
  function readFileAsDataURL(file){ return new Promise((ok,ng)=>{ const r=new FileReader(); r.onload=()=>ok(r.result); r.onerror=ng; r.readAsDataURL(file); }); }
  function loadImage(url){ return new Promise((ok,ng)=>{ const i=new Image(); i.onload=()=>ok(i); i.onerror=ng; i.src=url; }); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&quot;',"'":'&#39;'}[c])); }

  // é€éåˆ¤å®šï¼ˆPNGç”¨ï¼‰
  async function hasAlphaChannel(img){
    const w = Math.min(img.width, 512), h = Math.min(img.height, 512);
    const c = document.createElement('canvas'); c.width=w; c.height=h;
    const ctx = c.getContext('2d'); ctx.drawImage(img,0,0,w,h);
    const data = ctx.getImageData(0,0,w,h).data;
    for(let i=3; i<data.length; i+=16){ if(data[i] < 255) return true; }
    return false;
  }

  // 20MBä»¥å†…ã«åã‚ã‚‹æœ€å°é™æœ€é©åŒ–
  async function packToLimit(file, maxBytes){
    if(!((file.type||'').startsWith('image/'))) {
      const dataUrl = await readFileAsDataURL(file);
      const base64 = dataUrl.split(',')[1];
      return { base64, mime:(file.type||'application/octet-stream') };
    }

    // ãã®ã¾ã¾â†’OKãªã‚‰é€šã™
    let dataUrl = await readFileAsDataURL(file);
    let base64  = dataUrl.split(',')[1];
    if (Math.ceil(base64.length*3/4) <= maxBytes) return { base64, mime:file.type||'image/jpeg' };

    const img = await loadImage(dataUrl);
    const isPng = /^image\/png$/i.test(file.type||'');
    const alpha = isPng ? await hasAlphaChannel(img) : false;

    // JPEGï¼ˆã¾ãŸã¯é€éãªã—ï¼‰: å“è³ªèª¿æ•´â†’ã ã‚ãªã‚‰ç¸®å°
    if (!isPng || !alpha){
      let best = null;
      for (const q of [0.92, 0.86, 0.80, 0.74]) {
        const c = document.createElement('canvas'); c.width = img.width; c.height = img.height;
        c.getContext('2d').drawImage(img,0,0);
        const out = c.toDataURL('image/jpeg', q);
        const b64 = out.split(',')[1];
        if (Math.ceil(b64.length*3/4) <= maxBytes) { best = { base64:b64, mime:'image/jpeg' }; break; }
      }
      if (best) return best;

      const ratio = Math.max(0.2, Math.sqrt(maxBytes/(Math.ceil(base64.length*3/4))) * 0.92);
      const cw = Math.max(1, Math.round(img.width*ratio));
      const ch = Math.max(1, Math.round(img.height*ratio));
      const c2 = document.createElement('canvas'); c2.width=cw; c2.height=ch;
      c2.getContext('2d').drawImage(img,0,0,cw,ch);
      const out2 = c2.toDataURL('image/jpeg', 0.86);
      return { base64: out2.split(',')[1], mime:'image/jpeg' };
    }

    // PNGé€éã‚ã‚Šï¼šç¸®å°ã®ã¿
    let ratio = Math.max(0.2, Math.sqrt(maxBytes/(Math.ceil(base64.length*3/4))) * 0.95);
    let cw = Math.max(1, Math.round(img.width*ratio));
    let ch = Math.max(1, Math.round(img.height*ratio));
    for (let tries=0; tries<3; tries++){
      const c = document.createElement('canvas'); c.width=cw; c.height=ch;
      c.getContext('2d').drawImage(img,0,0,cw,ch);
      const out = c.toDataURL('image/png');
      const b64 = out.split(',')[1];
      if (Math.ceil(b64.length*3/4) <= maxBytes) return { base64:b64, mime:'image/png' };
      cw = Math.max(1, Math.round(cw * 0.85));
      ch = Math.max(1, Math.round(ch * 0.85));
    }

    // æœ€çµ‚æ‰‹æ®µï¼šJPEGåŒ–ï¼ˆé€éã¯å¤±ã‚ã‚Œã‚‹ï¼‰
    const c = document.createElement('canvas'); c.width=cw; c.height=ch;
    c.getContext('2d').drawImage(img,0,0,cw,ch);
    const out = c.toDataURL('image/jpeg', 0.86);
    return { base64: out.split(',')[1], mime:'image/jpeg' };
  }

  // ===== PWAï¼ˆä»»æ„ï¼‰ =====
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }

  // åˆæœŸåŒ–
  (async ()=>{
    await loadDestinations();
    setUIEnabled(true);
    render();
  })();
</script>
</body>
</html>
